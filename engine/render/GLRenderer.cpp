#include "GLRenderer.h"
#include "../ui/UIConstants.h"
#ifdef _WIN32
#define WIN32_LEAN_AND_MEAN
#include <windows.h>
#undef DrawText
#endif
#include <GL/gl.h>

namespace atlas::render {

void GLRenderer::SetViewport(int32_t width, int32_t height) {
    m_viewportWidth = width;
    m_viewportHeight = height;
}

void GLRenderer::BeginFrame() {
    glViewport(0, 0, m_viewportWidth, m_viewportHeight);
    glMatrixMode(GL_PROJECTION);
    glLoadIdentity();
    glOrtho(0.0, static_cast<double>(m_viewportWidth),
            static_cast<double>(m_viewportHeight), 0.0,
            -1.0, 1.0);
    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity();

    glClearColor(0.18f, 0.18f, 0.20f, 1.0f);
    glClear(GL_COLOR_BUFFER_BIT);

    glEnable(GL_BLEND);
    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
}

void GLRenderer::EndFrame() {
    glFlush();
}

static void glSetColor(const atlas::ui::UIColor& color) {
    glColor4ub(color.r, color.g, color.b, color.a);
}

void GLRenderer::DrawRect(const ui::UIRect& rect, const ui::UIColor& color) {
    glSetColor(color);
    glBegin(GL_QUADS);
    glVertex2i(rect.x, rect.y);
    glVertex2i(rect.x + rect.w, rect.y);
    glVertex2i(rect.x + rect.w, rect.y + rect.h);
    glVertex2i(rect.x, rect.y + rect.h);
    glEnd();
}

// -----------------------------------------------------------------------
// Minimal 5×7 bitmap font for printable ASCII (0x20–0x7E).
// Each glyph is stored as 7 rows of 5-bit bitmaps (MSB = leftmost pixel).
// This provides readable text without requiring an external font file.
// -----------------------------------------------------------------------
static const uint8_t kFont5x7[][7] = {
    // ' ' (0x20)
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // '!' 
    {0x04,0x04,0x04,0x04,0x04,0x00,0x04},
    // '"'
    {0x0A,0x0A,0x00,0x00,0x00,0x00,0x00},
    // '#'
    {0x0A,0x1F,0x0A,0x0A,0x1F,0x0A,0x00},
    // '$'
    {0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04},
    // '%'
    {0x18,0x19,0x02,0x04,0x08,0x13,0x03},
    // '&'
    {0x08,0x14,0x14,0x08,0x15,0x12,0x0D},
    // '\''
    {0x04,0x04,0x00,0x00,0x00,0x00,0x00},
    // '('
    {0x02,0x04,0x08,0x08,0x08,0x04,0x02},
    // ')'
    {0x08,0x04,0x02,0x02,0x02,0x04,0x08},
    // '*'
    {0x00,0x04,0x15,0x0E,0x15,0x04,0x00},
    // '+'
    {0x00,0x04,0x04,0x1F,0x04,0x04,0x00},
    // ','
    {0x00,0x00,0x00,0x00,0x00,0x04,0x08},
    // '-'
    {0x00,0x00,0x00,0x1F,0x00,0x00,0x00},
    // '.'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x04},
    // '/'
    {0x01,0x02,0x02,0x04,0x08,0x08,0x10},
    // '0'
    {0x0E,0x11,0x13,0x15,0x19,0x11,0x0E},
    // '1'
    {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E},
    // '2'
    {0x0E,0x11,0x01,0x06,0x08,0x10,0x1F},
    // '3'
    {0x0E,0x11,0x01,0x06,0x01,0x11,0x0E},
    // '4'
    {0x02,0x06,0x0A,0x12,0x1F,0x02,0x02},
    // '5'
    {0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E},
    // '6'
    {0x06,0x08,0x10,0x1E,0x11,0x11,0x0E},
    // '7'
    {0x1F,0x01,0x02,0x04,0x08,0x08,0x08},
    // '8'
    {0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E},
    // '9'
    {0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C},
    // ':'
    {0x00,0x00,0x04,0x00,0x00,0x04,0x00},
    // ';'
    {0x00,0x00,0x04,0x00,0x00,0x04,0x08},
    // '<'
    {0x02,0x04,0x08,0x10,0x08,0x04,0x02},
    // '='
    {0x00,0x00,0x1F,0x00,0x1F,0x00,0x00},
    // '>'
    {0x08,0x04,0x02,0x01,0x02,0x04,0x08},
    // '?'
    {0x0E,0x11,0x01,0x02,0x04,0x00,0x04},
    // '@'
    {0x0E,0x11,0x17,0x15,0x17,0x10,0x0E},
    // 'A'
    {0x0E,0x11,0x11,0x1F,0x11,0x11,0x11},
    // 'B'
    {0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E},
    // 'C'
    {0x0E,0x11,0x10,0x10,0x10,0x11,0x0E},
    // 'D'
    {0x1E,0x11,0x11,0x11,0x11,0x11,0x1E},
    // 'E'
    {0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F},
    // 'F'
    {0x1F,0x10,0x10,0x1E,0x10,0x10,0x10},
    // 'G'
    {0x0E,0x11,0x10,0x17,0x11,0x11,0x0E},
    // 'H'
    {0x11,0x11,0x11,0x1F,0x11,0x11,0x11},
    // 'I'
    {0x0E,0x04,0x04,0x04,0x04,0x04,0x0E},
    // 'J'
    {0x07,0x02,0x02,0x02,0x02,0x12,0x0C},
    // 'K'
    {0x11,0x12,0x14,0x18,0x14,0x12,0x11},
    // 'L'
    {0x10,0x10,0x10,0x10,0x10,0x10,0x1F},
    // 'M'
    {0x11,0x1B,0x15,0x15,0x11,0x11,0x11},
    // 'N'
    {0x11,0x19,0x15,0x13,0x11,0x11,0x11},
    // 'O'
    {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E},
    // 'P'
    {0x1E,0x11,0x11,0x1E,0x10,0x10,0x10},
    // 'Q'
    {0x0E,0x11,0x11,0x11,0x15,0x12,0x0D},
    // 'R'
    {0x1E,0x11,0x11,0x1E,0x14,0x12,0x11},
    // 'S'
    {0x0E,0x11,0x10,0x0E,0x01,0x11,0x0E},
    // 'T'
    {0x1F,0x04,0x04,0x04,0x04,0x04,0x04},
    // 'U'
    {0x11,0x11,0x11,0x11,0x11,0x11,0x0E},
    // 'V'
    {0x11,0x11,0x11,0x11,0x0A,0x0A,0x04},
    // 'W'
    {0x11,0x11,0x11,0x15,0x15,0x1B,0x11},
    // 'X'
    {0x11,0x11,0x0A,0x04,0x0A,0x11,0x11},
    // 'Y'
    {0x11,0x11,0x0A,0x04,0x04,0x04,0x04},
    // 'Z'
    {0x1F,0x01,0x02,0x04,0x08,0x10,0x1F},
    // '['
    {0x0E,0x08,0x08,0x08,0x08,0x08,0x0E},
    // '\\'
    {0x10,0x08,0x08,0x04,0x02,0x02,0x01},
    // ']'
    {0x0E,0x02,0x02,0x02,0x02,0x02,0x0E},
    // '^'
    {0x04,0x0A,0x11,0x00,0x00,0x00,0x00},
    // '_'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x1F},
    // '`'
    {0x08,0x04,0x00,0x00,0x00,0x00,0x00},
    // 'a'
    {0x00,0x00,0x0E,0x01,0x0F,0x11,0x0F},
    // 'b'
    {0x10,0x10,0x1E,0x11,0x11,0x11,0x1E},
    // 'c'
    {0x00,0x00,0x0E,0x11,0x10,0x11,0x0E},
    // 'd'
    {0x01,0x01,0x0F,0x11,0x11,0x11,0x0F},
    // 'e'
    {0x00,0x00,0x0E,0x11,0x1F,0x10,0x0E},
    // 'f'
    {0x06,0x08,0x1E,0x08,0x08,0x08,0x08},
    // 'g'
    {0x00,0x00,0x0F,0x11,0x0F,0x01,0x0E},
    // 'h'
    {0x10,0x10,0x1E,0x11,0x11,0x11,0x11},
    // 'i'
    {0x04,0x00,0x0C,0x04,0x04,0x04,0x0E},
    // 'j'
    {0x02,0x00,0x06,0x02,0x02,0x12,0x0C},
    // 'k'
    {0x10,0x10,0x12,0x14,0x18,0x14,0x12},
    // 'l'
    {0x0C,0x04,0x04,0x04,0x04,0x04,0x0E},
    // 'm'
    {0x00,0x00,0x1A,0x15,0x15,0x11,0x11},
    // 'n'
    {0x00,0x00,0x1E,0x11,0x11,0x11,0x11},
    // 'o'
    {0x00,0x00,0x0E,0x11,0x11,0x11,0x0E},
    // 'p'
    {0x00,0x00,0x1E,0x11,0x1E,0x10,0x10},
    // 'q'
    {0x00,0x00,0x0F,0x11,0x0F,0x01,0x01},
    // 'r'
    {0x00,0x00,0x16,0x19,0x10,0x10,0x10},
    // 's'
    {0x00,0x00,0x0F,0x10,0x0E,0x01,0x1E},
    // 't'
    {0x08,0x08,0x1E,0x08,0x08,0x09,0x06},
    // 'u'
    {0x00,0x00,0x11,0x11,0x11,0x11,0x0F},
    // 'v'
    {0x00,0x00,0x11,0x11,0x11,0x0A,0x04},
    // 'w'
    {0x00,0x00,0x11,0x11,0x15,0x15,0x0A},
    // 'x'
    {0x00,0x00,0x11,0x0A,0x04,0x0A,0x11},
    // 'y'
    {0x00,0x00,0x11,0x11,0x0F,0x01,0x0E},
    // 'z'
    {0x00,0x00,0x1F,0x02,0x04,0x08,0x1F},
    // '{'
    {0x02,0x04,0x04,0x08,0x04,0x04,0x02},
    // '|'
    {0x04,0x04,0x04,0x04,0x04,0x04,0x04},
    // '}'
    {0x08,0x04,0x04,0x02,0x04,0x04,0x08},
    // '~'
    {0x00,0x00,0x08,0x15,0x02,0x00,0x00},
};

void GLRenderer::DrawText(const ui::UIRect& rect, const std::string& text, const ui::UIColor& color) {
    // Render each character using the built-in 5×7 bitmap font.
    // Each glyph pixel is drawn as a 1×1 point so the text is readable
    // at the default scale.  The scale factor controls pixel size.
    glSetColor(color);

    const int glyphW = atlas::ui::kFontGlyphWidth;
    const int glyphH = atlas::ui::kFontGlyphHeight;
    const int scale  = atlas::ui::kFontScale;
    const int charW  = (glyphW + 1) * scale;  // 12px advance per char
    const int charH  = (glyphH + 2) * scale;  // 18px line height
    int cx = rect.x + 2;
    int cy = rect.y + 2;

    for (size_t i = 0; i < text.size(); ++i) {
        char ch = text[i];
        if (ch == '\n') {
            cx = rect.x + 2;
            cy += charH;
            if (cy + charH > rect.y + rect.h) break;
            continue;
        }
        if (cx + charW > rect.x + rect.w) break;

        // Map character to font table index
        int idx = static_cast<unsigned char>(ch) - 0x20;
        if (idx < 0 || idx >= static_cast<int>(sizeof(kFont5x7) / sizeof(kFont5x7[0]))) {
            // Non-printable: draw a small square placeholder
            glBegin(GL_QUADS);
            glVertex2i(cx, cy);
            glVertex2i(cx + glyphW * scale, cy);
            glVertex2i(cx + glyphW * scale, cy + glyphH * scale);
            glVertex2i(cx, cy + glyphH * scale);
            glEnd();
            cx += charW;
            continue;
        }

        // Draw glyph pixels as filled quads
        const uint8_t* glyph = kFont5x7[idx];
        for (int row = 0; row < glyphH; ++row) {
            uint8_t bits = glyph[row];
            for (int col = 0; col < glyphW; ++col) {
                if (bits & (0x10 >> col)) {
                    int px = cx + col * scale;
                    int py = cy + row * scale;
                    glBegin(GL_QUADS);
                    glVertex2i(px, py);
                    glVertex2i(px + scale, py);
                    glVertex2i(px + scale, py + scale);
                    glVertex2i(px, py + scale);
                    glEnd();
                }
            }
        }

        cx += charW;
    }
}

void GLRenderer::DrawIcon(const ui::UIRect& rect, uint32_t /*iconId*/, const ui::UIColor& tint) {
    // Placeholder: draw a diamond shape as icon stand-in
    glSetColor(tint);
    int cx = rect.x + rect.w / 2;
    int cy = rect.y + rect.h / 2;
    glBegin(GL_QUADS);
    glVertex2i(cx, rect.y);
    glVertex2i(rect.x + rect.w, cy);
    glVertex2i(cx, rect.y + rect.h);
    glVertex2i(rect.x, cy);
    glEnd();
}

void GLRenderer::DrawBorder(const ui::UIRect& rect, int32_t thickness, const ui::UIColor& color) {
    // Top
    DrawRect({rect.x, rect.y, rect.w, thickness}, color);
    // Bottom
    DrawRect({rect.x, rect.y + rect.h - thickness, rect.w, thickness}, color);
    // Left
    DrawRect({rect.x, rect.y, thickness, rect.h}, color);
    // Right
    DrawRect({rect.x + rect.w - thickness, rect.y, thickness, rect.h}, color);
}

void GLRenderer::DrawImage(const ui::UIRect& rect, uint32_t /*textureId*/, const ui::UIColor& tint) {
    // Placeholder: draw a tinted rectangle with a cross pattern
    DrawRect(rect, tint);

    ui::UIColor dark = {
        static_cast<uint8_t>(tint.r / 2),
        static_cast<uint8_t>(tint.g / 2),
        static_cast<uint8_t>(tint.b / 2),
        tint.a
    };

    glSetColor(dark);
    glBegin(GL_LINES);
    glVertex2i(rect.x, rect.y);
    glVertex2i(rect.x + rect.w, rect.y + rect.h);
    glVertex2i(rect.x + rect.w, rect.y);
    glVertex2i(rect.x, rect.y + rect.h);
    glEnd();
}

} // namespace atlas::render
