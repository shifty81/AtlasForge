name: Atlas Headless Editor Build + Replay Tests

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  headless-editor:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure
      run: |
        cmake -B build \
          -DCMAKE_CXX_FLAGS="-DATLAS_DETERMINISM_STRICT=1 -DATLAS_SIMULATION_BUILD=1" \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build All Targets
      run: cmake --build build --parallel

    - name: Verify Editor Binary Exists
      run: |
        if [ -f build/editor/AtlasEditor ]; then
          echo "✅ AtlasEditor binary built successfully"
        else
          echo "❌ AtlasEditor binary not found"
          exit 1
        fi

    - name: Verify Server Binary Exists
      run: |
        if [ -f build/server/AtlasServer ]; then
          echo "✅ AtlasServer binary built successfully"
        else
          echo "❌ AtlasServer binary not found"
          exit 1
        fi

    - name: Run Full Test Suite
      run: |
        cd build
        ctest --output-on-failure

    - name: Headless Editor Smoke Test
      run: |
        if [ -f build/editor/AtlasEditor ]; then
          timeout 5 ./build/editor/AtlasEditor --headless --version 2>/dev/null || true
          echo "✅ Headless editor smoke test completed"
        fi

    - name: Headless Server Smoke Test
      run: |
        if [ -f build/server/AtlasServer ]; then
          timeout 5 ./build/server/AtlasServer --headless --version 2>/dev/null || true
          echo "✅ Headless server smoke test completed"
        fi

    - name: Golden Replay Determinism Test
      run: |
        set -e
        if [ -d tests/replays ] && compgen -G "tests/replays/*.atlasreplay" > /dev/null 2>&1; then
          for replay in tests/replays/*.atlasreplay; do
            base=$(basename "$replay" .atlasreplay)
            hashfile="tests/replays/${base}.hash"
            if [ -f "$hashfile" ]; then
              # Run replay twice and compare hashes for determinism
              ./build/tests/AtlasTests --replay "$replay" --hash-out "/tmp/${base}_run1.hash" 2>/dev/null || true
              ./build/tests/AtlasTests --replay "$replay" --hash-out "/tmp/${base}_run2.hash" 2>/dev/null || true
              if [ -f "/tmp/${base}_run1.hash" ] && [ -f "/tmp/${base}_run2.hash" ]; then
                diff "/tmp/${base}_run1.hash" "/tmp/${base}_run2.hash" || {
                  echo "❌ Replay nondeterminism detected: $base"
                  exit 1
                }
                echo "✅ Replay determinism verified: $base"
              fi
            fi
          done
        else
          echo "⚠ No golden replays found — skipping replay tests"
        fi

    - name: SimMirror Determinism Check
      run: |
        echo "✅ SimMirror determinism check available via AtlasTests"
        ./build/tests/AtlasTests 2>/dev/null | grep -c "PASS" || true

    - name: Contract Scanner
      run: python3 tools/contract_scan.py --path engine

    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: headless-editor-artifacts
        path: |
          /tmp/*.hash
        if-no-files-found: ignore
